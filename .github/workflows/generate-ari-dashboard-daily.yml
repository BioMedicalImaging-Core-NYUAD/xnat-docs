name: Generate ARI Dashboard (Daily)

on:
  schedule:
    # Run at 5:47 PM Abu Dhabi time (1:47 PM UTC) - FOR IMMEDIATE TESTING
    - cron: '47 13 * * *'
  workflow_dispatch:
    inputs:
      description:
        description: 'Test run description'
        required: false
        default: 'Manual test of scheduled workflow'
        type: string

jobs:
  generate-dashboard:
    runs-on: self-hosted
    permissions:
      contents: write
      actions: read
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Set up Python environment
      run: |
        python3 -m pip install --upgrade pip
        python3 -m pip install pandas
        
    - name: Run ARI validation parser
      run: |
        echo "Starting ARI validation parser..."
        cd /home/mri/Documents/GitHub/ARIdashboard
        python3 parse_ari_validation.py
        echo "Parser completed successfully"
        
    - name: Verify output file exists
      run: |
        if [ -f "/home/mri/Documents/GitHub/ARIdashboard/xnat_ari_dashboard.csv" ]; then
          echo "Output file found"
          ls -la /home/mri/Documents/GitHub/ARIdashboard/xnat_ari_dashboard.csv
        else
          echo "Error: Output file not found"
          exit 1
        fi
        
    - name: Copy dashboard file to repository
      run: |
        cp /home/mri/Documents/GitHub/ARIdashboard/xnat_ari_dashboard.csv ./
        echo "Dashboard file copied to repository"
        
    - name: Generate dashboard content for documentation
      run: |
        python3 generate_dashboard.py
        echo "Dashboard content generated"
        
    - name: Copy CSV to documentation static folder
      run: |
        mkdir -p docs/source/_static
        cp xnat_ari_dashboard.csv docs/source/_static/
        echo "Full CSV file copied to documentation static folder"
        
    - name: Generate filtered CSV for display
      run: |
        python3 filter_dashboard_csv.py xnat_ari_dashboard.csv docs/source/_static/xnat_ari_dashboard_display.csv
        echo "Filtered CSV generated for documentation display"
        
    - name: Update ari-validator.rst with dashboard content
      run: |
        if [ -f "dashboard_content.rst" ]; then
          python3 update_docs.py
          echo "Documentation updated with dashboard content"
        else
          echo "Error: dashboard_content.rst not found"
          exit 1
        fi
        
    - name: Create timestamp file
      run: |
        echo "Generated on: $(date)" > dashboard_timestamp.txt
        if [ "${{ github.event_name }}" = "schedule" ]; then
          echo "Triggered by: Scheduled daily run" >> dashboard_timestamp.txt
          echo "Time: 5:47 PM Abu Dhabi (1:47 PM UTC) - TESTING" >> dashboard_timestamp.txt
        else
          echo "Triggered by: Manual test run" >> dashboard_timestamp.txt
          if [ -n "${{ inputs.description }}" ]; then
            echo "Description: ${{ inputs.description }}" >> dashboard_timestamp.txt
          fi
        fi
        echo "Run ID: ${{ github.run_id }}" >> dashboard_timestamp.txt
        echo "Event: ${{ github.event_name }}" >> dashboard_timestamp.txt
        
    - name: Check for changes
      id: check_changes
      run: |
        git add .
        if git diff --quiet --cached; then
          echo "changes=false" >> $GITHUB_OUTPUT
          echo "No changes detected in repository"
        else
          echo "changes=true" >> $GITHUB_OUTPUT
          echo "Changes detected in repository"
        fi
        
    - name: Configure git
      if: steps.check_changes.outputs.changes == 'true'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git remote set-url origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git
        
    - name: Commit and push changes
      if: steps.check_changes.outputs.changes == 'true'
      run: |
        if [ "${{ github.event_name }}" = "schedule" ]; then
          git commit -m "ðŸ“Š Daily ARI dashboard update - $(date '+%Y-%m-%d %H:%M:%S') [5:47PM Abu Dhabi - TESTING]"
        else
          git commit -m "ðŸ“Š Manual ARI dashboard update - $(date '+%Y-%m-%d %H:%M:%S') [Testing daily workflow]"
        fi
        git push origin ${{ github.ref_name }}
        
    - name: Upload dashboard as artifact
      uses: actions/upload-artifact@v4
      with:
        name: ari-dashboard-daily-${{ github.run_id }}
        path: |
          xnat_ari_dashboard.csv
          docs/source/_static/xnat_ari_dashboard_display.csv
          dashboard_timestamp.txt
          dashboard_content.rst
        retention-days: 30
        
    - name: Summary
      run: |
        echo "=== ARI Dashboard Daily Generation Summary ===" 
        echo "Status: âœ… Success"
        echo "Generated: $(date)"
        if [ "${{ github.event_name }}" = "schedule" ]; then
          echo "Schedule: Daily at 5:47 PM Abu Dhabi time (TESTING)"
        else
          echo "Trigger: Manual test run"
        fi
        echo "File location: ./xnat_ari_dashboard.csv"
        if [ -f "xnat_ari_dashboard.csv" ]; then
          echo "File size: $(du -h xnat_ari_dashboard.csv | cut -f1)"
          echo "Number of subjects: $(tail -n +2 xnat_ari_dashboard.csv | wc -l)"
        fi
        echo "Changes committed: ${{ steps.check_changes.outputs.changes }}"
        echo "Repository: https://github.com/BioMedicalImaging-Core-NYUAD/xnat-docs"